# Blueprint Schema Documentation

## Overview

Blueprints are JSON templates generated by the AI agent after successfully extracting categories from a website. They capture the extraction strategy and can be used for fast, non-AI extraction in the future.

## Purpose

1. **Reusability**: Use the blueprint for subsequent extractions without LLM costs
2. **Validation**: Compare future extractions against the blueprint
3. **Documentation**: Human-readable record of site structure
4. **Fallback**: Use when AI extraction fails
5. **Optimization**: Fast extraction for scheduled updates

## Blueprint Structure

### Complete Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "version": "1.0",
  "metadata": {
    "site_url": "https://example.com",
    "retailer_id": 1,
    "retailer_name": "Example Retailer",
    "generated_at": "2025-09-30T19:10:00Z",
    "generated_by": "ai_agent_v1",
    "agent_version": "0.1.0",
    "confidence_score": 0.92
  },
  "extraction_strategy": {
    "navigation_type": "hover_menu",
    "complexity": "medium",
    "requires_javascript": true,
    "dynamic_loading": {
      "enabled": true,
      "type": "lazy_load",
      "trigger": "scroll"
    }
  },
  "selectors": {
    "nav_container": "nav.main-navigation",
    "top_level_items": "li.menu-item",
    "category_links": "a.category-link",
    "category_name": "span.category-name",
    "flyout_panel": "div.submenu-panel",
    "subcategory_list": "ul.subcategory-list",
    "subcategory_items": "li.subcategory-item",
    "product_count": "span.product-count",
    "show_more_button": "button.show-more",
    "loading_indicator": ".loading-spinner"
  },
  "interactions": [
    {
      "step": 1,
      "action": "hover",
      "target": "top_level_items",
      "wait_for": "flyout_panel",
      "timeout": 2000,
      "description": "Hover over main category to reveal submenu"
    },
    {
      "step": 2,
      "action": "wait",
      "duration": 500,
      "description": "Wait for flyout animation"
    },
    {
      "step": 3,
      "action": "extract",
      "target": "subcategory_items",
      "description": "Extract all subcategories from flyout"
    },
    {
      "step": 4,
      "action": "click",
      "target": "show_more_button",
      "optional": true,
      "wait_for": "subcategory_items",
      "timeout": 1000,
      "description": "Click 'Show More' if present"
    }
  ],
  "validation_rules": {
    "min_categories": 10,
    "max_categories": 1000,
    "max_depth": 4,
    "url_pattern": "^https://example\\.com/[a-z0-9-]+$",
    "required_fields": ["name", "url"]
  },
  "extraction_stats": {
    "total_categories": 156,
    "max_depth": 3,
    "extraction_duration_ms": 45230,
    "categories_by_depth": {
      "0": 12,
      "1": 58,
      "2": 76,
      "3": 10
    }
  },
  "edge_cases": [
    {
      "type": "cookie_consent",
      "handler": "auto_accept",
      "selector": "button#accept-cookies"
    },
    {
      "type": "popup",
      "handler": "close",
      "selector": ".modal-close"
    },
    {
      "type": "bot_detection",
      "handler": "wait",
      "duration": 5000
    }
  ],
  "notes": [
    "Site uses hover-based mega menu",
    "Categories load dynamically on hover",
    "Product counts may not be accurate",
    "Some categories have deep nesting (depth 3)",
    "Site occasionally shows promotional popups"
  ]
}
```

### Field Descriptions

#### metadata
- `site_url`: Base URL of the website
- `retailer_id`: Database ID of the retailer
- `retailer_name`: Human-readable retailer name
- `generated_at`: ISO 8601 timestamp of blueprint creation
- `generated_by`: Tool that created the blueprint
- `agent_version`: Version of the agent
- `confidence_score`: AI confidence in extraction strategy (0.0-1.0)

#### extraction_strategy
- `navigation_type`: Type of navigation pattern
  - `hover_menu`: Flyout menus on hover
  - `sidebar`: Static sidebar navigation
  - `dropdown`: Click-based dropdowns
  - `mega_menu`: Large multi-column menus
  - `accordion`: Expandable accordion sections
  - `grid`: Grid-based category tiles
  - `tabs`: Tab-based navigation
  - `other`: Custom or unknown pattern

- `complexity`: Extraction difficulty
  - `simple`: Basic HTML links
  - `medium`: Requires interactions
  - `complex`: Dynamic loading, complex interactions

- `requires_javascript`: Whether JavaScript is needed
- `dynamic_loading`: Configuration for dynamic content

#### selectors
CSS selectors for all category elements. Each selector should be:
- **Specific**: Targets only category elements
- **Stable**: Unlikely to change with minor site updates
- **Validated**: Confirmed to work during extraction

#### interactions
Ordered list of actions to perform:
- `step`: Execution order (1, 2, 3, ...)
- `action`: Type of interaction
  - `navigate`: Go to URL
  - `hover`: Hover over element
  - `click`: Click element
  - `wait`: Wait for duration or selector
  - `scroll`: Scroll to element or position
  - `extract`: Extract data from elements
  - `type`: Type text into input

- `target`: Selector or position to interact with
- `wait_for`: Selector to wait for after action
- `timeout`: Maximum wait time in milliseconds
- `optional`: Whether action is optional (skip if target not found)
- `description`: Human-readable description

#### validation_rules
Rules for validating extracted data:
- `min_categories`: Minimum expected categories
- `max_categories`: Maximum expected categories
- `max_depth`: Maximum category depth
- `url_pattern`: Regex pattern for category URLs
- `required_fields`: Fields that must be present in each category

#### extraction_stats
Statistics from the extraction that created this blueprint:
- `total_categories`: Total categories found
- `max_depth`: Maximum depth encountered
- `extraction_duration_ms`: Time taken in milliseconds
- `categories_by_depth`: Distribution of categories by depth level

#### edge_cases
Known issues and their handling strategies:
- `type`: Type of edge case
  - `cookie_consent`: Cookie consent banner
  - `popup`: Marketing popup or modal
  - `bot_detection`: Anti-bot measures
  - `rate_limit`: Rate limiting
  - `auth_required`: Authentication needed
  - `geo_restriction`: Geographic restrictions

- `handler`: How to handle
  - `auto_accept`: Automatically accept/dismiss
  - `close`: Close the element
  - `wait`: Wait for it to disappear
  - `manual`: Requires manual intervention
  - `ignore`: Can be ignored

## Example Blueprints

### Example 1: Simple Sidebar Navigation

```json
{
  "version": "1.0",
  "metadata": {
    "site_url": "https://simplestore.com",
    "retailer_id": 5,
    "generated_at": "2025-09-30T19:10:00Z",
    "confidence_score": 0.95
  },
  "extraction_strategy": {
    "navigation_type": "sidebar",
    "complexity": "simple",
    "requires_javascript": false,
    "dynamic_loading": {
      "enabled": false
    }
  },
  "selectors": {
    "nav_container": "aside.category-sidebar",
    "category_links": "ul.category-list > li > a",
    "category_name": "span.name",
    "subcategory_list": "ul.subcategories",
    "product_count": "span.count"
  },
  "interactions": [
    {
      "step": 1,
      "action": "extract",
      "target": "category_links",
      "description": "Extract all category links from sidebar"
    }
  ],
  "validation_rules": {
    "min_categories": 5,
    "max_categories": 100,
    "max_depth": 2
  }
}
```

### Example 2: Complex Hover Menu (Clicks.co.za)

```json
{
  "version": "1.0",
  "metadata": {
    "site_url": "https://clicks.co.za",
    "retailer_id": 1,
    "retailer_name": "Clicks",
    "generated_at": "2025-09-30T19:10:00Z",
    "confidence_score": 0.88
  },
  "extraction_strategy": {
    "navigation_type": "sidebar",
    "complexity": "complex",
    "requires_javascript": true,
    "dynamic_loading": {
      "enabled": true,
      "type": "click_more",
      "trigger": "button.read-more-facet"
    }
  },
  "selectors": {
    "nav_container": "div.panel.panel-default.bg-white",
    "category_list": "ul.facet_block",
    "category_items": "li",
    "category_name": "span[id^='facetName_']",
    "category_url_anchor": "label.facet_block-label",
    "category_url_input": "input.hidden-lg.hidden-sm.hidden-xs.hidden-md",
    "product_count": "span.facetcountDiv.facetValueCount",
    "show_more_button": "button.read-more-facet",
    "expand_toggle": "a.refinementToggle"
  },
  "interactions": [
    {
      "step": 1,
      "action": "navigate",
      "target": "https://clicks.co.za/products/c/OH1",
      "wait_for": "nav_container",
      "timeout": 60000
    },
    {
      "step": 2,
      "action": "click",
      "target": "expand_toggle",
      "wait_for": "category_list",
      "timeout": 3000,
      "optional": true
    },
    {
      "step": 3,
      "action": "click",
      "target": "show_more_button",
      "wait_for": "category_items",
      "timeout": 2000,
      "optional": true,
      "description": "Click 'See more' to reveal all categories"
    },
    {
      "step": 4,
      "action": "extract",
      "target": "category_items",
      "description": "Extract category data from facet list"
    }
  ],
  "validation_rules": {
    "min_categories": 50,
    "max_categories": 500,
    "max_depth": 3,
    "url_pattern": "^https://clicks\\.co\\.za/products/",
    "required_fields": ["name", "url", "product_count"]
  },
  "edge_cases": [
    {
      "type": "bot_detection",
      "handler": "wait",
      "duration": 120000,
      "description": "Clicks uses Cloudflare with 2min timeout"
    },
    {
      "type": "cookie_consent",
      "handler": "auto_accept",
      "selector": "button:has-text('Accept')"
    }
  ],
  "notes": [
    "Uses sidebar filter instead of top navigation",
    "Categories are facet filters, not traditional nav",
    "URLs stored in hidden input fields",
    "Product counts displayed next to each category",
    "Cloudflare challenge common on first visit"
  ]
}
```

## Using Blueprints

### Blueprint-Based Extraction

```python
"""Extract categories using a blueprint."""
import json
from playwright.async_api import Page

async def extract_with_blueprint(page: Page, blueprint_path: str) -> list:
    """Execute extraction using blueprint."""
    
    # Load blueprint
    with open(blueprint_path) as f:
        blueprint = json.load(f)
    
    selectors = blueprint["selectors"]
    interactions = blueprint["interactions"]
    
    categories = []
    
    # Execute interactions in order
    for interaction in sorted(interactions, key=lambda x: x["step"]):
        action = interaction["action"]
        
        if action == "navigate":
            await page.goto(interaction["target"])
            if interaction.get("wait_for"):
                await page.wait_for_selector(
                    selectors[interaction["wait_for"]],
                    timeout=interaction.get("timeout", 30000)
                )
        
        elif action == "click":
            selector = selectors[interaction["target"]]
            try:
                await page.click(selector, timeout=interaction.get("timeout", 5000))
            except:
                if not interaction.get("optional"):
                    raise
        
        elif action == "hover":
            selector = selectors[interaction["target"]]
            await page.hover(selector)
        
        elif action == "wait":
            duration = interaction.get("duration", 1000)
            await page.wait_for_timeout(duration)
        
        elif action == "extract":
            selector = selectors[interaction["target"]]
            elements = await page.query_selector_all(selector)
            
            for element in elements:
                name = await element.text_content()
                url = await element.get_attribute("href")
                categories.append({"name": name, "url": url})
    
    return categories
```

### Blueprint Validation

```python
"""Validate extracted data against blueprint."""

def validate_against_blueprint(categories: list, blueprint: dict) -> dict:
    """Validate extraction results."""
    
    rules = blueprint["validation_rules"]
    issues = []
    
    # Check category count
    total = len(categories)
    if total < rules["min_categories"]:
        issues.append(f"Too few categories: {total} < {rules['min_categories']}")
    if total > rules["max_categories"]:
        issues.append(f"Too many categories: {total} > {rules['max_categories']}")
    
    # Check max depth
    max_depth = max(cat.get("depth", 0) for cat in categories)
    if max_depth > rules["max_depth"]:
        issues.append(f"Depth exceeded: {max_depth} > {rules['max_depth']}")
    
    # Check required fields
    for cat in categories:
        for field in rules["required_fields"]:
            if field not in cat or not cat[field]:
                issues.append(f"Missing required field '{field}' in: {cat.get('name')}")
    
    # Check URL pattern
    import re
    url_pattern = re.compile(rules.get("url_pattern", ".*"))
    for cat in categories:
        if not url_pattern.match(cat.get("url", "")):
            issues.append(f"Invalid URL pattern: {cat.get('url')}")
    
    return {
        "valid": len(issues) == 0,
        "issues": issues,
        "categories_count": total,
        "max_depth": max_depth
    }
```

## Blueprint Versioning

Blueprints should be versioned when:
- Site structure changes
- Selectors become invalid
- Extraction strategy improves
- Edge cases discovered

**Naming Convention**: `{retailer_name}_v{version}_{date}.json`

Example: `clicks_v2_2025-09-30.json`

## Storage

Store blueprints in:
- **Local**: `./blueprints/` directory
- **Database**: JSON column in retailers table
- **S3**: For production backups

```sql
ALTER TABLE retailers ADD COLUMN blueprint JSONB;
UPDATE retailers SET blueprint = '...' WHERE id = 1;
```
